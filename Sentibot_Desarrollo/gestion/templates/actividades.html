{% extends "base.html" %}
{% load static %}

{% block title %}Actividades para {{ emocion.nombre_emocion }}{% endblock %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<div class="container py-5 text-center">

  <!-- TÃ­tulo general elegante -->
  <div class="mb-5">
    <h1 class="fw-bold display-4 mb-2"
        style="font-family: 'Comic Sans MS', cursive, sans-serif;">
      <span class="emoticono-principal">
        {% if emocion.nombre_emocion == "AlegrÃ­a" %}ğŸ˜„
        {% elif emocion.nombre_emocion == "Tristeza" %}ğŸ˜¢
        {% elif emocion.nombre_emocion == "Miedo" %}ğŸ˜¨
        {% elif emocion.nombre_emocion == "Enojo" %}ğŸ˜¡
        {% elif emocion.nombre_emocion == "Neutral" %}ğŸ˜
        {% else %}ğŸ§©{% endif %}
      </span>
      <span style="color: #f8f9fa;">EmociÃ³n detectada: <span class="text-capitalize">{{ emocion.nombre_emocion }}</span></span>
    </h1>
    {% if emocion.descripcion %}
      <p class="fs-5 fw-semibold fst-italic mt-2" style="color: #adb5bd;">
        Explora estas actividades para mejorar tu estado de Ã¡nimo y bienestar ğŸ˜Š
      </p>
    {% endif %}
  </div>

  <!-- Actividades -->
  <div class="row justify-content-center g-4">
    {% if recomendaciones %}
      {% for rec in recomendaciones %}
        <div class="col-md-4">
          <div class="card actividad-card shadow-lg border-0 rounded-4 h-100 p-3"
               style="cursor:pointer; background: #f8f9fa;"
               data-bs-toggle="modal" 
               data-bs-target="#modalActividad{{ forloop.counter }}">
            <div class="card-body d-flex flex-column">
              
              <!-- TÃ­tulo con emoticono y color elegante -->
              <h5 class="card-title fw-bold titulo-actividad mb-3">
                <span class="emoticono">{{ rec.actividad.emoticono|default:"ğŸ¯" }}</span>
                <span class="titulo-texto">{{ rec.actividad.nombre_actividad }}</span>
              </h5>

              <p class="card-text text-muted text-truncate">{{ rec.actividad.descripcion|default:"Sin descripciÃ³n disponible." }}</p>

              <!-- Se recomienda + barra de porcentaje -->
              <div class="mt-4">
                <div class="text-muted fw-semibold mb-1">Se recomienda:</div>
                <div class="progress rounded-pill" style="height: 20px;">
                  <div class="progress-bar porcentaje-elegante" role="progressbar"
                       style="width: {{ rec.porcentaje }}%;
                              {% if rec.porcentaje >= 95 or rec.porcentaje == max_porcentaje %}background-color: #28a745;
                              {% elif rec.porcentaje >= 50 %}background-color: #ffc107;
                              {% else %}background-color: #6c757d;
                              {% endif %}"
                       aria-valuenow="{{ rec.porcentaje }}" aria-valuemin="0" aria-valuemax="100">
                  </div>
                </div>
                <div class="mt-1 fw-bold text-dark">{{ rec.porcentaje }}%</div>
              </div>

            </div>
          </div>
        </div>

        <!-- Modal elegante -->
        <div class="modal fade" id="modalActividad{{ forloop.counter }}" tabindex="-1" aria-labelledby="modalLabel{{ forloop.counter }}" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered modal-md">
            <div class="modal-content rounded-4 shadow-lg">
              <div class="modal-header bg-dark text-white">
                <h5 class="modal-title fs-5" id="modalLabel{{ forloop.counter }}">
                  âœ¨ {{ rec.actividad.nombre_actividad }} âœ¨
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
              </div>
              <div class="modal-body bg-light text-dark">
                {% if rec.actividad.recurso %}
                  <div class="ratio ratio-16x9 mb-3 rounded-3 overflow-hidden shadow-sm">
                    <iframe src="{{ rec.embed_url }}" title="Video de {{ rec.actividad.nombre_actividad }}" allowfullscreen></iframe>
                  </div>
                {% endif %}

                <div class="mb-3 p-3 bg-white rounded-3 shadow-sm">
                  <p>ğŸ“ <strong>DescripciÃ³n:</strong> {{ rec.actividad.descripcion }}</p>
                  <p>ğŸ› ï¸ <strong>CÃ³mo realizarla:</strong> {{ rec.actividad.como_realizarla }}</p>
                </div>

                {% if rec.actividad.recurso %}
                  <a href="{{ rec.actividad.recurso }}" target="_blank" class="btn btn-dark mt-2 w-100 rounded-pill fw-bold">
                    ğŸ”— Ver recurso completo
                  </a>
                {% endif %}
              </div>
              <div class="modal-footer bg-light">
                <!-- BotÃ³n cerrar modal -->
                <button type="button" class="btn btn-outline-dark rounded-pill fw-semibold" data-bs-dismiss="modal">
                  Cerrar âŒ
                </button>

                <!-- BotÃ³n finalizar actividad -->
                <!-- BotÃ³n finalizar actividad (cierra sesiÃ³n y luego encuesta) -->
                <a href="{% url 'finalizar_y_encuesta' %}" 
                  class="btn btn-success rounded-pill fw-bold text-white">
                  Finalizar âœ…
                </a>

              </div>
            </div>
          </div>
        </div>

      {% endfor %}
    {% else %}
      <p class="text-secondary fs-5">No hay actividades disponibles para esta emociÃ³n ğŸ˜….</p>
    {% endif %}
    
  </div>
</div>

<style>
/* TÃ­tulos y emoticonos */
.titulo-actividad .titulo-texto {
  font-size: 1.3rem;
  color: #343a40;
}
.titulo-actividad .emoticono {
  margin-right: 0.3rem;
  font-size: 1.5rem;
}

/* Tarjetas hover elegante */
.actividad-card {
  transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
}
.actividad-card:hover {
  transform: translateY(-6px);
  box-shadow: 0 1.5rem 2.5rem rgba(0,0,0,0.25);
  background: #e9ecef;
}

/* Barra de porcentaje */
.progress {
  background-color: #dee2e6;
}
.progress-bar {
  transition: width 0.5s ease-in-out;
}
</style>
<script>
window.addEventListener("beforeunload", function (e) {
    // Llamar al backend para cerrar sesiÃ³n activa
    navigator.sendBeacon("{% url 'cerrar_sesion_ajax' %}");
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
