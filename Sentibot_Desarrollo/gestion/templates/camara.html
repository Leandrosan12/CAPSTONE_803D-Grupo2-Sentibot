{% extends "base.html" %}
{% block title %}Monitoreo de Emociones{% endblock %}
{% block content %}
{% load static %}

<style>
body {
  font-family: Arial, sans-serif;
  background: #f0f2f5;
  text-align: center;
  padding: 20px;
}

.camara-container {
  position: relative;
  width: 100%;
  max-width: 640px;
  margin: 0 auto 20px;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

video {
  width: 100%;
  border-radius: 12px;
}

.overlay {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 220px;
  height: 220px;
  border: 3px solid #7ED321;
  transform: translate(-50%, -50%);
  pointer-events: none;
}

.estado {
  background: rgba(0,0,0,0.8);
  color: white;
  position: absolute;
  bottom: 0;
  width: 100%;
  padding: 8px;
  font-weight: bold;
}

#emocionEnCamara {
  position: absolute;
  top: 15px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.75);
  color: #fff;
  padding: 8px 16px;
  border-radius: 8px;
  font-weight: bold;
}
</style>

<h2>üé• Monitoreo de Emociones</h2>

<div class="camara-container">
  <video id="videoCamara" autoplay playsinline></video>
  <div class="overlay"></div>
  <div id="emocionEnCamara">Sin reconocer ‚Äî 0%</div>
  <div class="estado" id="estadoCamara">Apagado</div>
</div>

<div>
  <button id="startBtn">Iniciar C√°mara</button>
</div>

<div id="reporte" style="margin-top: 30px;">
  <h3>Reporte de emociones (segundos)</h3>
  <p id="alegria">Alegr√≠a: 0 seg</p>
  <p id="enojo">Enojo: 0 seg</p>
  <p id="miedo">Miedo: 0 seg</p>
  <p id="neutral">Neutral: 0 seg</p>
  <p id="tristeza">Tristeza: 0 seg</p>
  <p id="sinreconocer">Sin reconocer: 0 seg</p>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const videoCamara = document.getElementById("videoCamara");
  const startBtn = document.getElementById("startBtn");
  const emocionEnCamara = document.getElementById("emocionEnCamara");
  const estadoCamara = document.getElementById("estadoCamara");

  const emociones = {
    alegria: 0,
    enojo: 0,
    miedo: 0,
    neutral: 0,
    tristeza: 0,
    sinreconocer: 0
  };

  let camaraEncendida = false;
  let stream = null;
  let intervaloEnvio = null;

  // === API del modelo (FastAPI en ngrok) ===
  const API_URL = "https://negational-kerry-untoward.ngrok-free.dev/predict_emotion/";

  startBtn.addEventListener("click", async () => {
    if (!camaraEncendida) {
      // === ENCENDER C√ÅMARA ===
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true });
        videoCamara.srcObject = stream;
        camaraEncendida = true;
        startBtn.textContent = "Apagar C√°mara";
        estadoCamara.textContent = "C√°mara activa";

        // Enviar frames cada 1.5 segundos
        intervaloEnvio = setInterval(capturarYPredecir, 1500);
      } catch (e) {
        console.error("Error al iniciar c√°mara:", e);
        estadoCamara.textContent = "Error: permiso denegado o c√°mara no disponible";
      }
    } else {
      // === APAGAR C√ÅMARA ===
      detenerCamara();
    }
  });

  function detenerCamara() {
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
      stream = null;
    }
    videoCamara.srcObject = null;
    camaraEncendida = false;
    clearInterval(intervaloEnvio);
    intervaloEnvio = null;
    startBtn.textContent = "Iniciar C√°mara";
    estadoCamara.textContent = "Apagado";
    emocionEnCamara.textContent = "Sin reconocer ‚Äî 0%";
  }

  async function capturarYPredecir() {
    if (!camaraEncendida || !videoCamara.videoWidth) return;

    const canvas = document.createElement("canvas");
    canvas.width = 224;
    canvas.height = 224;
    const ctx = canvas.getContext("2d");

    // Captura un recorte centrado del video
    const vw = videoCamara.videoWidth;
    const vh = videoCamara.videoHeight;
    const sx = (vw - 224) / 2;
    const sy = (vh - 224) / 2;
    ctx.drawImage(videoCamara, sx, sy, 224, 224, 0, 0, 224, 224);

    const blob = await new Promise(resolve => canvas.toBlob(resolve, "image/jpeg"));
    const formData = new FormData();
    formData.append("file", blob, "frame.jpg");

    fetch(API_URL, {
      method: "POST",
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      const emocion = (data.emotion || "sinreconocer").toLowerCase();
      const confianza = data.confidence || 0;

      emocionEnCamara.textContent = `${emocion.charAt(0).toUpperCase() + emocion.slice(1)} ‚Äî ${confianza.toFixed(1)}%`;

      if (emocion in emociones) {
        emociones[emocion] += 1.5;
        actualizarReporte();
      }
    })
    .catch(err => {
      console.error("Error al predecir:", err);
      emocionEnCamara.textContent = "‚ö†Ô∏è Error API";
    });
  }

  function actualizarReporte() {
    for (const emo in emociones) {
      const el = document.getElementById(emo);
      if (el) {
        el.textContent = `${emo.charAt(0).toUpperCase() + emo.slice(1)}: ${Math.round(emociones[emo])} seg`;
      }
    }
  }
});
</script>

{% endblock %}
