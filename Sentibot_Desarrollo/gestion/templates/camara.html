{% extends "base.html" %}
{% block title %}Monitoreo de Emociones{% endblock %}
{% block content %}
{% load static %}

<div class="container py-3 text-center">

  <!-- C√°mara -->
  <div class="card bg-dark border-0 shadow mx-auto mb-3" style="width: 460px; border-radius: 1rem;">
    <div class="card-body p-0 position-relative">

      <!-- Video -->
      <div class="bg-black position-relative overflow-hidden rounded-top" style="height: 320px;">
        <video id="videoCamara" autoplay playsinline class="w-100 h-100" style="object-fit: cover;"></video>

        <!-- Cuadro azul -->
        <div id="overlay-deteccion" 
             class="position-absolute top-50 start-50 translate-middle border border-3 rounded" 
             style="width: 170px; height: 170px; border-image: linear-gradient(135deg, #48c6ef, #6f86d6) 1; box-shadow: 0 0 20px rgba(111,134,214,0.6);">
        </div>
      </div>

      <!-- Indicador emoci√≥n -->
      <div id="emocionEnCamara"
           class="position-absolute top-0 start-50 translate-middle-x mt-3 px-3 py-1 rounded-pill fw-semibold text-white shadow"
           style="background: linear-gradient(90deg, #48c6ef, #6f86d6); font-size: 0.9rem;">
        Sin reconocer ‚Äî 0%
      </div>

      <!-- Estado -->
      <div id="estadoCamara" class="bg-secondary text-white py-1 fw-bold rounded-bottom small">
        Apagado
      </div>
    </div>
  </div>

  <!-- Bot√≥n -->
  <div class="mb-4">
    <button id="startBtn" class="btn btn-primary btn-lg shadow-sm fw-semibold px-4">
      Iniciar C√°mara
    </button>
  </div>

  <!-- Reporte -->
  <div class="card border-0 shadow-sm mx-auto" style="border-radius: 1rem; max-width: 1000px; background-color: #f8f9fa;">
    <div class="card-body py-3 px-4">
      <h5 class="fw-bold mb-4 text-center"
          style="background: linear-gradient(90deg, #48c6ef, #6f86d6); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
        üìä Reporte de Emociones
      </h5>

      <div class="d-flex justify-content-center flex-wrap gap-3">
        <div class="p-3 bg-light rounded shadow-sm d-flex flex-column align-items-center" style="min-width: 130px;">
          <span class="fw-semibold text-warning">üòä Alegr√≠a</span>
          <span id="alegria" class="fw-bold text-secondary">0 seg</span>
        </div>

        <div class="p-3 bg-light rounded shadow-sm d-flex flex-column align-items-center" style="min-width: 130px;">
          <span class="fw-semibold text-danger">üò† Enojo</span>
          <span id="enojo" class="fw-bold text-secondary">0 seg</span>
        </div>

        <div class="p-3 bg-light rounded shadow-sm d-flex flex-column align-items-center" style="min-width: 130px;">
          <span class="fw-semibold text-success">üò® Miedo</span>
          <span id="miedo" class="fw-bold text-secondary">0 seg</span>
        </div>

        <div class="p-3 bg-light rounded shadow-sm d-flex flex-column align-items-center" style="min-width: 130px;">
          <span class="fw-semibold text-info">üòê Neutral</span>
          <span id="neutral" class="fw-bold text-secondary">0 seg</span>
        </div>

        <div class="p-3 bg-light rounded shadow-sm d-flex flex-column align-items-center" style="min-width: 130px;">
          <span class="fw-semibold" style="color: #b06ab3;">üò¢ Tristeza</span>
          <span id="tristeza" class="fw-bold text-secondary">0 seg</span>
        </div>

        <div class="p-3 bg-light rounded shadow-sm d-flex flex-column align-items-center" style="min-width: 130px;">
          <span class="fw-semibold text-muted">‚ùî Sin reconocer</span>
          <span id="sinreconocer" class="fw-bold text-secondary">0 seg</span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const videoCamara = document.getElementById("videoCamara");
  const startBtn = document.getElementById("startBtn");
  const emocionEnCamara = document.getElementById("emocionEnCamara");
  const estadoCamara = document.getElementById("estadoCamara");

  const DURACION_TOTAL = 10; // segundos
  const emociones = { alegria: 0, enojo: 0, miedo: 0, neutral: 0, tristeza: 0, sinreconocer: 0 };
  const probabilidades = { alegria: [], enojo: [], miedo: [], neutral: [], tristeza: [], sinreconocer: [] };

  let camaraEncendida = false;
  let stream = null;
  let intervaloEnvio = null;
  let tiempoTranscurrido = 0;

  const API_URL = "https://negational-kerry-untoward.ngrok-free.dev/predict_emotion/";
  const SESION_ID = "{{ sesion_id }}"; // pasado desde la vista

  // Funci√≥n para obtener CSRF
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.startsWith(name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  startBtn.addEventListener("click", async () => {
    if (!camaraEncendida) {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true });
        videoCamara.srcObject = stream;
        camaraEncendida = true;
        startBtn.textContent = "Apagar C√°mara";
        startBtn.classList.replace("btn-primary", "btn-danger");
        estadoCamara.textContent = "C√°mara activa";
        tiempoTranscurrido = 0;

        intervaloEnvio = setInterval(() => {
          tiempoTranscurrido += 1.5;
          capturarYPredecir();

          if (tiempoTranscurrido >= DURACION_TOTAL) {
            detenerCamara();
            enviarEmocionDominante();
          }
        }, 1500);

      } catch (e) {
        console.error("Error al iniciar c√°mara:", e);
        estadoCamara.textContent = "Error: permiso denegado o c√°mara no disponible";
      }
    } else {
      detenerCamara();
    }
  });

  function detenerCamara() {
    if (stream) stream.getTracks().forEach(track => track.stop());
    videoCamara.srcObject = null;
    camaraEncendida = false;
    clearInterval(intervaloEnvio);
    intervaloEnvio = null;
    startBtn.textContent = "Iniciar C√°mara";
    startBtn.classList.replace("btn-danger", "btn-primary");
    estadoCamara.textContent = "Apagado";
    emocionEnCamara.textContent = "Sin reconocer ‚Äî 0%";
  }

  async function capturarYPredecir() {
    if (!camaraEncendida || !videoCamara.videoWidth) return;

    const canvas = document.createElement("canvas");
    canvas.width = 224; canvas.height = 224;
    const ctx = canvas.getContext("2d");

    const sx = (videoCamara.videoWidth - 224) / 2;
    const sy = (videoCamara.videoHeight - 224) / 2;
    ctx.drawImage(videoCamara, sx, sy, 224, 224, 0, 0, 224, 224);

    const blob = await new Promise(resolve => canvas.toBlob(resolve, "image/jpeg"));
    const formData = new FormData();
    formData.append("file", blob, "frame.jpg");

    fetch(API_URL, { method: "POST", body: formData })
      .then(res => res.json())
      .then(data => {
        const emocion = (data.emotion || "sinreconocer").toLowerCase();
        const confianza = data.confidence || 0;

        emocionEnCamara.textContent = `${emocion.charAt(0).toUpperCase()+emocion.slice(1)} ‚Äî ${confianza.toFixed(1)}%`;

        if (emocion in emociones) {
          emociones[emocion] += 1.5;              // acumulamos segundos
          probabilidades[emocion].push(confianza); // acumulamos % de confianza
          actualizarReporte();
        }
      })
      .catch(err => {
        console.error("Error al predecir:", err);
        emocionEnCamara.textContent = "‚ö†Ô∏è Error API";
      });
  }

  function actualizarReporte() {
    for (const emo in emociones) {
      const el = document.getElementById(emo);
      if (el) el.textContent = `${emo.charAt(0).toUpperCase()+emo.slice(1)}: ${Math.round(emociones[emo])} seg`;
    }
  }

  async function enviarEmocionDominante() {
    // Determinar la emoci√≥n con m√°s tiempo
    const dominante = Object.keys(emociones).reduce((a,b)=> emociones[a]>emociones[b]?a:b);

    // Calcular promedio de confianza
    const probs = probabilidades[dominante];
    const promedio = probs.length ? probs.reduce((sum,p)=>sum+p,0)/probs.length : 0;

    const csrftoken = getCookie('csrftoken');

    await fetch(`/procesar_emocion_camara/${SESION_ID}/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': csrftoken, 'Content-Type': 'application/json' },
      body: JSON.stringify({ emocion: dominante, porcentaje: promedio })
    });

    window.location.href = `/actividades/${dominante}/`;
  }

});
</script>


{% endblock %}
