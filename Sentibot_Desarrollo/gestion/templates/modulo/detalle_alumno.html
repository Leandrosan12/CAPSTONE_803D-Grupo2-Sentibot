{% extends 'base.html' %}
{% load static %}

{% block title %}üìÑ Detalle Alumno{% endblock %}

{% block content %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

<style>
.chart-container {
    width: 100%;
    max-width: 350px;
    height: 260px;
    margin: 0 auto;
    position: relative;
}
.switch-container {
    display: flex;
    justify-content: flex-start;
    align-items: center;
    margin-bottom: 0.5rem;
}
</style>

<div id="pdfContenido">
<div id="alumnoInfo" class="card text-white bg-dark mb-4">
    <div class="card-body d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
            <img src="{% static 'icon/avatar.png' %}" class="rounded-circle border border-white me-3"
                 style="width:80px; height:80px;">
            <div>
                <h2 class="h4 mb-1">{{ alumno.first_name }} {{ alumno.last_name }}</h2>
                <p class="mb-1"><strong>Email:</strong> {{ alumno.email }}</p>
            </div>
        </div>
        <div>
            <a href="{% url 'alumnos' %}" class="btn btn-secondary me-2">‚¨ÖÔ∏è Volver</a>
            <button id="downloadPDF" class="btn btn-warning">üìÑ Descargar PDF</button>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- 1) EMOCIONES TOTALES -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-body text-center">
                <div class="switch-container">
                    <input class="form-check-input me-2" type="checkbox" id="switchEmociones">
                    <label for="switchEmociones">%</label>
                </div>
                <h5>üü£ Emociones Totales</h5>
                <div class="chart-container"><canvas id="chartEmociones"></canvas></div>
            </div>
        </div>
    </div>

    <!-- 2) TIEMPO PROMEDIO -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-body text-center">
                <h5>‚è± Tiempo Promedio de Sesi√≥n</h5>
                <div class="chart-container"><canvas id="chartTiempo"></canvas></div>
            </div>
        </div>
    </div>

    <!-- 3) UTILIDAD ENCUESTA -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-body text-center">
                <div class="switch-container">
                    <input class="form-check-input me-2" type="checkbox" id="switchUtilidad">
                    <label for="switchUtilidad"> %</label>
                </div>
                <h5>üìä Encuesta: ¬øLe gust√≥?</h5>
                <div class="chart-container"><canvas id="chartUtilidad"></canvas></div>
            </div>
        </div>
    </div>

    <!-- 4) RECOMENDACI√ìN -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-body text-center">
                <h5>‚≠ê Recomendaci√≥n 1-5</h5>
                <div class="chart-container"><canvas id="chartRecomendacion"></canvas></div>
            </div>
        </div>
    </div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    let emociones = JSON.parse('{{ emociones_json|escapejs }}');
    let utilidad = JSON.parse('{{ utilidad_json|escapejs }}');
    let recomend = JSON.parse('{{ recomend_json|escapejs }}');
    let tiempoPromedio = parseFloat('{{ tiempo_promedio|floatformat:2 }}') || 0;

    function renderPie(chart, dataObj, showPercent) {
        const total = Object.values(dataObj).reduce((a,b)=>a+b,0);
        chart.data.datasets[0].data = Object.values(dataObj).map(v => showPercent ? (v/total*100).toFixed(1) : v);
        chart.options.plugins.datalabels.formatter = v => showPercent ? v+'%' : v;
        chart.update();
    }

    const chartEmociones = new Chart(document.getElementById("chartEmociones"), {
        type:'pie',
        data:{ labels:Object.keys(emociones), datasets:[{ data:Object.values(emociones), backgroundColor:["#FF6384","#36A2EB","#FFCE56","#FF9F40","#4BC0C0"] }] },
        options:{ responsive:true, maintainAspectRatio:false, plugins:{ datalabels:{ color:'#fff', font:{weight:'bold'}, formatter:v=>v } } },
        plugins:[ChartDataLabels]
    });
    document.getElementById("switchEmociones").addEventListener("change", e => renderPie(chartEmociones, emociones, e.target.checked));

    const chartTiempo = new Chart(document.getElementById("chartTiempo"), {
        type:'bar',
        data:{ labels:["Tiempo promedio (min)"], datasets:[{ label:"Duraci√≥n sesi√≥n", data:[tiempoPromedio], backgroundColor:"#28a745" }] },
        options:{
            responsive:true,
            maintainAspectRatio:false,
            plugins:{ datalabels:{ color:'#fff', anchor:'center', align:'center', font:{weight:'bold', size:14}, formatter:v=>v } },
            scales:{ y:{ beginAtZero:true } }
        },
        plugins:[ChartDataLabels]
    });

    const chartUtilidad = new Chart(document.getElementById("chartUtilidad"), {
        type:'pie',
        data:{ labels:Object.keys(utilidad), datasets:[{ data:Object.values(utilidad), backgroundColor:["#28a745","#dc3545"] }] },
        options:{ responsive:true, maintainAspectRatio:false, plugins:{ datalabels:{ color:'#fff', font:{weight:'bold'}, formatter:v=>v } } },
        plugins:[ChartDataLabels]
    });
    document.getElementById("switchUtilidad").addEventListener("change", e => renderPie(chartUtilidad, utilidad, e.target.checked));

    const chartRecomendacion = new Chart(document.getElementById("chartRecomendacion"), {
        type:'bar',
        data:{ labels:Object.keys(recomend), datasets:[{ label:'Cantidad de respuestas', data:Object.values(recomend), backgroundColor:'#ffc107' }] },
        options:{ 
            responsive:true, maintainAspectRatio:false,
            plugins:{ datalabels:{ color:'#000', anchor:'center', align:'center', font:{weight:'bold', size:14}, formatter:v=>v } },
            scales:{ y:{ beginAtZero:true } }
        },
        plugins:[ChartDataLabels]
    });

    // --- PDF ---
   document.getElementById("downloadPDF").addEventListener("click", () => {
        html2canvas(document.getElementById("pdfContenido"), { scale: 2 }).then(canvas => {
            const imgData = canvas.toDataURL("image/png");
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF("p", "mm", "a4");
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
            pdf.addImage(imgData, "PNG", 0, 0, pdfWidth, pdfHeight);
            pdf.save("detalle_alumno.pdf");
        });
    });

});
</script>

{% endblock %}
