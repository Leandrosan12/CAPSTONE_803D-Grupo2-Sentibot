{% extends 'base.html' %}
{% load static %}

{% block title %}üìä Dashboard Emocional{% endblock %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
    .card {
        height: 100%;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .card-chart {
        position: relative;
        height: 350px;
        width: 100%;
        margin: auto;
    }
    @media print {
        .no-print { display: none !important; }
    }
    #pdfContenido {
        background: white;
        padding: 20px;
    }
</style>

<div class="dashboard-wrapper container-fluid py-5">

  <!-- CABECERA (NO SALE EN PDF) -->
  <div class="dashboard-header mb-4 text-center no-print">
    <h2>üìä Dashboard Emocional ‚Äì {{ escuela.nombre }}</h2>

    <div class="acciones mt-3">
      <a href="{% url 'modulo_profesor' %}" class="btn btn-secondary">‚¨ÖÔ∏è Volver</a>
      <button id="descargarPDF" class="btn btn-primary">üìÑ Descargar PDF</button>
    </div>
  </div>

  <!-- CONTENIDO DEL PDF -->
  <div id="pdfContenido">

    <div class="text-center mb-4">
      <h2 class="fw-bold">üìä Dashboard Emocional ‚Äì {{ escuela.nombre }}</h2>
      <p id="infoPDF" class="fw-bold"></p>
    </div>

    <div class="container">
      <div class="row g-4 justify-content-center">

        <!-- GR√ÅFICO PRINCIPAL -->
        <div class="col-12 col-md-10">
          <div class="card w-100 p-3">
            <h4 class="text-center">Usuarios por Emoci√≥n</h4>
            <div class="card-chart">
              <canvas id="graficoUsuariosEmocion"></canvas>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- LIBRER√çAS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* ================================
   DATOS DE DJANGO ‚Üí JAVASCRIPT
   ================================ */
const emocionesEscuela = {{ emociones_por_escuela|safe }};

console.log("üìä Datos recibidos:", emocionesEscuela);

/* FECHA PDF */
document.addEventListener("DOMContentLoaded", () => {

    const fecha = new Date();
    document.getElementById("infoPDF").innerHTML =
        `üìÖ Fecha: ${fecha.toLocaleDateString("es-CL")} ‚Äî üïí ${fecha.toLocaleTimeString("es-CL")}`;

    /* GR√ÅFICO DE PASTEL */
    const ctx = document.getElementById("graficoUsuariosEmocion");

    new Chart(ctx, {
        type: "pie",
        data: {
            labels: Object.keys(emocionesEscuela),
            datasets: [{
                data: Object.values(emocionesEscuela),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: "bottom" }
            }
        }
    });
});

/* DESCARGA PDF */
document.getElementById("descargarPDF").addEventListener("click", async () => {

  await new Promise(resolve => setTimeout(resolve, 300));

  html2canvas(document.getElementById("pdfContenido"), {
      scale: 3,
      useCORS: true,
      allowTaint: true,
  }).then(canvas => {
      const imgData = canvas.toDataURL("image/png");
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF("p", "mm", "a4");

      const pdfWidth = pdf.internal.pageSize.getWidth();
      const imgProps = pdf.getImageProperties(imgData);
      const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

      pdf.addImage(imgData, "PNG", 0, 0, pdfWidth, pdfHeight);
      pdf.save("dashboard_emocional.pdf");
  });

});
</script>

{% endblock %}
